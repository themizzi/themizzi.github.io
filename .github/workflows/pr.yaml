name: PR Build

on:
# Run on all PRs to main
  pull_request:
    branches: [main]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pull-requests: write
  packages: write
  deployments: write

env:
  CLOUDFLARE_PROJECT: 'joemizzi'
  CLOUDFLARE_BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      deployment-id: ${{ steps.deployment.outputs.deployment-id }}
      deployment-url: ${{ steps.deploy.outputs.deployment-url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # - name: Create GitHub Deployment
      #   id: deployment
      #   uses: ./.github/actions/github-deployment
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     environment: 'production'
      #     ref: ${{ github.event.pull_request.head.sha }}
      #     description: 'Deploy PR #${{ github.event.pull_request.number }}'
      #     action: 'create'

      # - name: Deploy to Digital Ocean
      #   id: deploy
      #   uses: ./.github/actions/deploy-app
      #   with:
      #     token: ${{ secrets.DIGITAL_OCEAN_ACCESS_TOKEN }}
      #     app-id: ${{ env.APP_ID }}
      #     deploy-pr-preview: 'true'
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     deployment-id: ${{ steps.deployment.outputs.deployment-id }}
      #     environment: 'production'
      #     image-tag: 'pr-${{ github.event.pull_request.number }}'

      - name: Create GitHub Deployment (Cloudflare preview)
        id: cloudflare-deployment
        uses: ./.github/actions/github-deployment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          environment: 'cloudflare-pr-${{ github.event.pull_request.number }}'
          ref: ${{ github.event.pull_request.head.sha }}
          description: 'Deploy Cloudflare preview for PR #${{ github.event.pull_request.number }}'
          action: 'create'

      - name: Start Cloudflare deployment (preview)
        if: steps.cloudflare-deployment.outputs.deployment-id != ''
        uses: ./.github/actions/github-deployment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deployment-id: ${{ steps.cloudflare-deployment.outputs.deployment-id }}
          action: 'update-status'
          status: 'in_progress'

      - name: Build site & deploy Cloudflare preview (devcontainer)
        id: cloudflare-preview
        uses: devcontainers/ci@v0.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          imageName: ghcr.io/${{ github.repository }}/devcontainer
          imageTag: 'pr-${{ github.event.pull_request.number }}'
          cacheFrom: ghcr.io/${{ github.repository }}/devcontainer
          push: always
          runCmd: make deploy
          env: |
            CLOUDFLARE_BRANCH_NAME=${{ env.CLOUDFLARE_BRANCH_NAME }}
            CLOUDFLARE_PROJECT=${{ env.CLOUDFLARE_PROJECT }}
            CLOUDFLARE_API_TOKEN=${{ env.CLOUDFLARE_API_TOKEN }}
              
      - name: Determine Cloudflare preview URL
        id: cloudflare-preview-url
        if: steps.cloudflare-preview.outcome == 'success'
        shell: bash
        run: |
          set -euo pipefail
          branch="${{ env.CLOUDFLARE_BRANCH_NAME }}"
          project="${{ env.CLOUDFLARE_PROJECT }}"
          sanitized=$(echo "$branch" | tr '[:upper:]' '[:lower:]')
          sanitized=$(echo "$sanitized" | sed 's/[^a-z0-9-]/-/g')
          sanitized=$(echo "$sanitized" | sed 's/-\{2,\}/-/g')
          sanitized=$(echo "$sanitized" | sed 's/^-//' | sed 's/-$//')
          if [ -z "$sanitized" ]; then
            sanitized='preview'
          fi
          echo "alias-url=https://${sanitized}.${project}.pages.dev" >> "$GITHUB_OUTPUT"

      - name: Mark Cloudflare preview success
        if: steps.cloudflare-preview.outcome == 'success' && steps.cloudflare-deployment.outputs.deployment-id != ''
        uses: ./.github/actions/github-deployment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deployment-id: ${{ steps.cloudflare-deployment.outputs.deployment-id }}
          action: 'update-status'
          status: 'success'
          deployment-url: ${{ steps.cloudflare-preview-url.outputs.alias-url }}

      - name: Mark Cloudflare preview failure
        if: failure() && steps.cloudflare-preview.outcome == 'failure' && steps.cloudflare-deployment.outputs.deployment-id != ''
        uses: ./.github/actions/github-deployment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deployment-id: ${{ steps.cloudflare-deployment.outputs.deployment-id }}
          action: 'update-status'
          status: 'failure'
